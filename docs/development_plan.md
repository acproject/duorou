# Duorou 开发计划

## 项目概述

Duorou 是一个模仿 Ollama 的多平台桌面应用服务，主要用于调用本地AI模型，同时支持云端服务调用。项目集成了 llama.cpp 和 stable-diffusion.cpp 两个核心C++项目，采用串行工作流模式以优化机器资源使用。

## 技术栈

- **编程语言**: C++17/20
- **构建系统**: CMake
- **GUI框架**: GTK4
- **版本控制**: Git
- **核心依赖**:
  - llama.cpp (文本生成模型)
  - stable-diffusion.cpp (图像生成模型)

## 项目架构

### 目录结构
```
duorou/
├── src/                    # 主要源代码
│   ├── core/              # 核心功能模块
│   ├── gui/               # GTK4 界面代码
│   ├── models/            # 模型管理
│   ├── workflow/          # 串行工作流引擎
│   └── utils/             # 工具函数
├── third_party/           # 第三方依赖
│   ├── llama.cpp/         # LLM推理引擎
│   └── stable-diffusion.cpp/  # 图像生成引擎
├── doc/                   # 文档
├── tests/                 # 测试代码
├── resources/             # 资源文件
└── CMakeLists.txt         # 构建配置
```

## 开发阶段

### 第一阶段：基础架构 (Week 1-2)

1. **项目初始化**
   - [x] Git仓库初始化
   - [x] 子模块集成 (llama.cpp, stable-diffusion.cpp)
   - [x] 基础目录结构
   - [x] CMake配置文件

2. **核心模块设计**
   - [ ] 模型管理器 (ModelManager)
   - [ ] 工作流引擎 (WorkflowEngine)
   - [ ] 配置管理 (ConfigManager)
   - [ ] 日志系统 (Logger)

### 第二阶段：模型集成 (Week 3-4)

1. **llama.cpp集成**
   - [ ] 封装llama.cpp API
   - [ ] 文本生成接口
   - [ ] 模型加载/卸载管理
   - [ ] 内存优化

2. **stable-diffusion.cpp集成**
   - [ ] 封装stable-diffusion.cpp API
   - [ ] 图像生成接口
   - [ ] 模型切换机制
   - [ ] GPU/CPU资源管理

### 第三阶段：工作流引擎 (Week 5-6)

1. **串行工作流设计**
   - [ ] 任务队列管理
   - [ ] 资源锁定机制
   - [ ] 任务优先级调度
   - [ ] 错误处理和恢复

2. **模型切换优化**
   - [ ] 智能模型预加载
   - [ ] 内存回收策略
   - [ ] 模型缓存机制

### 第四阶段：GUI开发 (Week 7-8)

1. **GTK4界面设计**
   - [ ] 主窗口布局
   - [ ] 聊天界面
   - [ ] 图像生成界面
   - [ ] 设置面板

2. **系统托盘集成**
   - [ ] 托盘图标和菜单
   - [ ] 后台运行模式
   - [ ] 状态指示器

### 第五阶段：云端服务集成 (Week 9-10)

1. **API接口设计**
   - [ ] OpenAI兼容API
   - [ ] 自定义云端服务接口
   - [ ] 认证和安全机制

2. **混合推理模式**
   - [ ] 本地/云端智能切换
   - [ ] 负载均衡
   - [ ] 网络错误处理

### 第六阶段：优化和测试 (Week 11-12)

1. **性能优化**
   - [ ] 内存使用优化
   - [ ] 推理速度优化
   - [ ] 启动时间优化

2. **测试和调试**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] 性能测试
   - [ ] 多平台兼容性测试

## 核心功能特性

### 模型管理
- 支持多种模型格式 (GGUF, GGML, SafeTensors)
- 自动模型下载和更新
- 模型性能基准测试
- 模型元数据管理

### 工作流引擎
- 串行任务执行，避免资源冲突
- 智能资源调度
- 任务队列可视化
- 实时性能监控

### 用户界面
- 现代化GTK4界面
- 响应式设计
- 主题切换支持
- 多语言支持

### 系统集成
- 跨平台支持 (Linux, macOS, Windows)
- 系统托盘集成
- 开机自启动
- 系统资源监控

## 技术挑战和解决方案

### 内存管理
- **挑战**: 大型模型内存占用
- **解决方案**: 智能模型卸载、内存映射、量化技术

### 性能优化
- **挑战**: 模型切换延迟
- **解决方案**: 预加载策略、增量加载、模型缓存

### 跨平台兼容
- **挑战**: 不同平台的编译和依赖管理
- **解决方案**: CMake配置优化、条件编译、CI/CD流水线

## 质量保证

### 代码质量
- 代码审查流程
- 静态代码分析
- 编码规范遵循
- 文档完整性

### 测试策略
- 单元测试覆盖率 > 80%
- 集成测试自动化
- 性能回归测试
- 用户验收测试

## 发布计划

### Alpha版本 (Week 8)
- 基础功能完成
- 内部测试

### Beta版本 (Week 10)
- 功能完整
- 公开测试

### 正式版本 (Week 12)
- 稳定发布
- 文档完善

## 维护和更新

- 定期更新依赖库
- 安全补丁及时发布
- 用户反馈收集和处理
- 新功能迭代开发

---

**注意**: 本开发计划会根据实际开发进度和需求变化进行调整。